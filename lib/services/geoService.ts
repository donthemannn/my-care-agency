// ============================================
// GEOGRAPHIC SERVICE
// ============================================
// Handles ZIP code to county FIPS mapping using SMARTYSTREETS API
// with fallback to manual Alabama county mapping

import { SmartyStreetsResponse, CountyInfo } from '../types';

export class GeoService {
  private authId: string;
  private authToken: string;
  private baseUrl = 'https://us-zipcode.api.smartystreets.com/lookup';

  constructor() {
    this.authId = process.env.SMARTYSTREETS_AUTH_ID || '';
    this.authToken = process.env.SMARTYSTREETS_AUTH_TOKEN || '';
    
    if (!this.authId || !this.authToken) {
      console.warn('SMARTYSTREETS credentials not found. Using fallback mapping.');
    }
  }

  // ============================================
  // ALABAMA COUNTY FIPS MAPPING (FALLBACK)
  // ============================================
  
  private alabamaCountyMapping: Record<string, CountyInfo> = {
    // Major Alabama Counties with sample zip codes
    '01001': { fips: '01001', name: 'Autauga', state: 'AL', zipCodes: ['36003', '36006', '36067'] },
    '01003': { fips: '01003', name: 'Baldwin', state: 'AL', zipCodes: ['36502', '36507', '36511', '36526', '36527', '36530', '36532', '36535', '36541', '36542', '36544', '36549', '36551', '36561', '36562', '36564', '36571', '36575', '36576', '36582'] },
    '01005': { fips: '01005', name: 'Barbour', state: 'AL', zipCodes: ['36310', '36321', '36322'] },
    '01007': { fips: '01007', name: 'Bibb', state: 'AL', zipCodes: ['35004', '35020', '35094'] },
    '01009': { fips: '01009', name: 'Blount', state: 'AL', zipCodes: ['35031', '35049', '35077', '35079', '35121'] },
    '01011': { fips: '01011', name: 'Bullock', state: 'AL', zipCodes: ['36032', '36067'] },
    '01013': { fips: '01013', name: 'Butler', state: 'AL', zipCodes: ['36022', '36040', '36064'] },
    '01015': { fips: '01015', name: 'Calhoun', state: 'AL', zipCodes: ['36201', '36202', '36203', '36204', '36205', '36206', '36207', '36265', '36268', '36269'] },
    '01017': { fips: '01017', name: 'Chambers', state: 'AL', zipCodes: ['36832', '36854', '36860', '36863', '36867'] },
    '01019': { fips: '01019', name: 'Cherokee', state: 'AL', zipCodes: ['35901', '35960', '35967', '35971', '35976'] },
    '01021': { fips: '01021', name: 'Chilton', state: 'AL', zipCodes: ['35006', '35014', '35040', '35043', '35146'] },
    '01023': { fips: '01023', name: 'Choctaw', state: 'AL', zipCodes: ['36512', '36518'] },
    '01025': { fips: '01025', name: 'Clarke', state: 'AL', zipCodes: ['36425', '36432', '36451', '36471'] },
    '01027': { fips: '01027', name: 'Clay', state: 'AL', zipCodes: ['36278', '36279'] },
    '01029': { fips: '01029', name: 'Cleburne', state: 'AL', zipCodes: ['36240', '36256', '36264'] },
    '01031': { fips: '01031', name: 'Coffee', state: 'AL', zipCodes: ['36330', '36350', '36351', '36352'] },
    '01033': { fips: '01033', name: 'Colbert', state: 'AL', zipCodes: ['35630', '35631', '35632', '35633', '35634', '35640', '35645', '35647', '35648', '35649', '35661', '35674'] },
    '01035': { fips: '01035', name: 'Conecuh', state: 'AL', zipCodes: ['36420', '36441', '36460'] },
    '01037': { fips: '01037', name: 'Coosa', state: 'AL', zipCodes: ['35010', '35087'] },
    '01039': { fips: '01039', name: 'Covington', state: 'AL', zipCodes: ['36420', '36441', '36460'] },
    '01041': { fips: '01041', name: 'Crenshaw', state: 'AL', zipCodes: ['36022', '36040', '36064'] },
    '01043': { fips: '01043', name: 'Cullman', state: 'AL', zipCodes: ['35055', '35056', '35057', '35058', '35077', '35097'] },
    '01045': { fips: '01045', name: 'Dale', state: 'AL', zipCodes: ['36301', '36303', '36305', '36310', '36321', '36322'] },
    '01047': { fips: '01047', name: 'Dallas', state: 'AL', zipCodes: ['36701', '36702', '36703', '36720', '36726', '36728'] },
    '01049': { fips: '01049', name: 'DeKalb', state: 'AL', zipCodes: ['35901', '35960', '35967', '35971', '35976'] },
    '01051': { fips: '01051', name: 'Elmore', state: 'AL', zipCodes: ['36003', '36006', '36043', '36067', '36092'] },
    '01053': { fips: '01053', name: 'Escambia', state: 'AL', zipCodes: ['36420', '36441', '36460'] },
    '01055': { fips: '01055', name: 'Etowah', state: 'AL', zipCodes: ['35901', '35903', '35904', '35905', '35906', '35907'] },
    '01057': { fips: '01057', name: 'Fayette', state: 'AL', zipCodes: ['35555', '35570', '35576'] },
    '01059': { fips: '01059', name: 'Franklin', state: 'AL', zipCodes: ['35565', '35570', '35576'] },
    '01061': { fips: '01061', name: 'Geneva', state: 'AL', zipCodes: ['36340', '36345', '36350'] },
    '01063': { fips: '01063', name: 'Greene', state: 'AL', zipCodes: ['35441', '35444', '35449'] },
    '01065': { fips: '01065', name: 'Hale', state: 'AL', zipCodes: ['35441', '35444', '35449'] },
    '01067': { fips: '01067', name: 'Henry', state: 'AL', zipCodes: ['36301', '36303', '36305'] },
    '01069': { fips: '01069', name: 'Houston', state: 'AL', zipCodes: ['36301', '36303', '36305'] },
    '01071': { fips: '01071', name: 'Jackson', state: 'AL', zipCodes: ['35739', '35740', '35741', '35742', '35744', '35745', '35746', '35747', '35748', '35749', '35750', '35751', '35752', '35754', '35755', '35756', '35757', '35758', '35759', '35760', '35761', '35762', '35763', '35764', '35765', '35766', '35767', '35768', '35769', '35770', '35771', '35772', '35773', '35774', '35775', '35776', '35801', '35802', '35803', '35804', '35805', '35806', '35807', '35808', '35809', '35810', '35811', '35812', '35813', '35814', '35815', '35816', '35824', '35893', '35894', '35895', '35896', '35897', '35898', '35899'] },
    '01073': { fips: '01073', name: 'Jefferson', state: 'AL', zipCodes: ['35004', '35005', '35006', '35007', '35020', '35021', '35022', '35023', '35040', '35043', '35068', '35071', '35080', '35094', '35111', '35114', '35116', '35117', '35118', '35119', '35120', '35121', '35124', '35126', '35127', '35128', '35130', '35131', '35133', '35134', '35135', '35136', '35137', '35138', '35139', '35142', '35143', '35144', '35146', '35147', '35148', '35149', '35150', '35151', '35160', '35173', '35175', '35176', '35178', '35179', '35180', '35182', '35184', '35185', '35186', '35187', '35188', '35201', '35202', '35203', '35204', '35205', '35206', '35207', '35208', '35209', '35210', '35211', '35212', '35213', '35214', '35215', '35216', '35217', '35218', '35219', '35220', '35221', '35222', '35223', '35224', '35226', '35228', '35229', '35233', '35234', '35235', '35236', '35237', '35238', '35242', '35243', '35244', '35246', '35249', '35253', '35254', '35255', '35259', '35260', '35266', '35282', '35283', '35285', '35287', '35288', '35290', '35291', '35292', '35293', '35294', '35295', '35296', '35297', '35298'] },
    '01075': { fips: '01075', name: 'Lamar', state: 'AL', zipCodes: ['35555', '35570', '35576'] },
    '01077': { fips: '01077', name: 'Lauderdale', state: 'AL', zipCodes: ['35630', '35631', '35632', '35633', '35634', '35640', '35645', '35647', '35648', '35649', '35661', '35674'] },
    '01079': { fips: '01079', name: 'Lawrence', state: 'AL', zipCodes: ['35650', '35651', '35652', '35653', '35654', '35660', '35671', '35673'] },
    '01081': { fips: '01081', name: 'Lee', state: 'AL', zipCodes: ['36801', '36802', '36803', '36804', '36830', '36832', '36849', '36854', '36860', '36863', '36867', '36869', '36870', '36871', '36874', '36875', '36877', '36879'] },
    '01083': { fips: '01083', name: 'Limestone', state: 'AL', zipCodes: ['35611', '35613', '35614', '35616', '35618', '35620', '35621', '35640', '35645', '35647', '35648', '35649', '35661', '35674', '35739', '35740', '35741', '35742', '35744', '35745', '35746', '35747', '35748', '35749', '35750', '35751', '35752', '35754', '35755', '35756', '35757', '35758', '35759', '35760', '35761', '35762', '35763', '35764', '35765', '35766', '35767', '35768', '35769', '35770', '35771', '35772', '35773', '35774', '35775', '35776', '35801', '35802', '35803', '35804', '35805', '35806', '35807', '35808', '35809', '35810', '35811', '35812', '35813', '35814', '35815', '35816', '35824', '35893', '35894', '35895', '35896', '35897', '35898', '35899'] },
    '01085': { fips: '01085', name: 'Lowndes', state: 'AL', zipCodes: ['36040', '36041', '36064', '36067'] },
    '01087': { fips: '01087', name: 'Macon', state: 'AL', zipCodes: ['36032', '36067', '36830'] },
    '01089': { fips: '01089', name: 'Madison', state: 'AL', zipCodes: ['35739', '35740', '35741', '35742', '35744', '35745', '35746', '35747', '35748', '35749', '35750', '35751', '35752', '35754', '35755', '35756', '35757', '35758', '35759', '35760', '35761', '35762', '35763', '35764', '35765', '35766', '35767', '35768', '35769', '35770', '35771', '35772', '35773', '35774', '35775', '35776', '35801', '35802', '35803', '35804', '35805', '35806', '35807', '35808', '35809', '35810', '35811', '35812', '35813', '35814', '35815', '35816', '35824', '35893', '35894', '35895', '35896', '35897', '35898', '35899'] },
    '01091': { fips: '01091', name: 'Marengo', state: 'AL', zipCodes: ['36720', '36726', '36728', '36740', '36741', '36742', '36744', '36748', '36749', '36750', '36751', '36752', '36756', '36758', '36759', '36761', '36762', '36763', '36764', '36765', '36766', '36767', '36768', '36769', '36773', '36775', '36776', '36778', '36782', '36783', '36784', '36785', '36786', '36790', '36792', '36793'] },
    '01093': { fips: '01093', name: 'Marion', state: 'AL', zipCodes: ['35565', '35570', '35576'] },
    '01095': { fips: '01095', name: 'Marshall', state: 'AL', zipCodes: ['35901', '35960', '35967', '35971', '35976'] },
    '01097': { fips: '01097', name: 'Mobile', state: 'AL', zipCodes: ['36502', '36503', '36504', '36505', '36506', '36507', '36508', '36509', '36510', '36511', '36512', '36513', '36515', '36518', '36521', '36522', '36523', '36524', '36525', '36526', '36527', '36528', '36529', '36530', '36532', '36533', '36534', '36535', '36536', '36538', '36540', '36541', '36542', '36544', '36545', '36547', '36548', '36549', '36551', '36553', '36555', '36558', '36559', '36560', '36561', '36562', '36564', '36567', '36568', '36569', '36571', '36572', '36574', '36575', '36576', '36577', '36578', '36579', '36580', '36581', '36582', '36583', '36584', '36585', '36587', '36590', '36601', '36602', '36603', '36604', '36605', '36606', '36607', '36608', '36609', '36610', '36611', '36612', '36613', '36615', '36616', '36617', '36618', '36619', '36628', '36633', '36640', '36641', '36644', '36652', '36660', '36663', '36670', '36671', '36675', '36685', '36689', '36691', '36693', '36695'] },
    '01099': { fips: '01099', name: 'Monroe', state: 'AL', zipCodes: ['36420', '36441', '36460'] },
    '01101': { fips: '01101', name: 'Montgomery', state: 'AL', zipCodes: ['36003', '36006', '36043', '36064', '36067', '36092', '36101', '36102', '36103', '36104', '36105', '36106', '36107', '36108', '36109', '36110', '36111', '36112', '36113', '36115', '36116', '36117', '36118', '36119', '36120', '36121', '36123', '36124', '36125', '36130', '36131', '36132', '36135', '36140', '36141', '36142', '36177', '36191'] },
    '01103': { fips: '01103', name: 'Morgan', state: 'AL', zipCodes: ['35611', '35613', '35614', '35616', '35618', '35620', '35621'] },
    '01105': { fips: '01105', name: 'Perry', state: 'AL', state: 'AL', zipCodes: ['36720', '36726', '36728'] },
    '01107': { fips: '01107', name: 'Pickens', state: 'AL', zipCodes: ['35441', '35444', '35449'] },
    '01109': { fips: '01109', name: 'Pike', state: 'AL', zipCodes: ['36022', '36040', '36064'] },
    '01111': { fips: '01111', name: 'Randolph', state: 'AL', zipCodes: ['36240', '36256', '36264'] },
    '01113': { fips: '01113', name: 'Russell', state: 'AL', zipCodes: ['36854', '36860', '36863', '36867'] },
    '01115': { fips: '01115', name: 'St. Clair', state: 'AL', zipCodes: ['35004', '35020', '35094', '35121', '35128', '35133', '35146'] },
    '01117': { fips: '01117', name: 'Shelby', state: 'AL', zipCodes: ['35004', '35006', '35007', '35040', '35043', '35080', '35114', '35116', '35117', '35118', '35119', '35120', '35121', '35124', '35126', '35127', '35128', '35130', '35131', '35133', '35134', '35135', '35136', '35137', '35138', '35139', '35142', '35143', '35144', '35146', '35147', '35148', '35149', '35150', '35151', '35160', '35173', '35175', '35176', '35178', '35179', '35180', '35182', '35184', '35185', '35186', '35187', '35188', '35242', '35243', '35244', '35246', '35249'] },
    '01119': { fips: '01119', name: 'Sumter', state: 'AL', zipCodes: ['35441', '35444', '35449'] },
    '01121': { fips: '01121', name: 'Talladega', state: 'AL', zipCodes: ['35010', '35087', '35120', '35121', '35160'] },
    '01123': { fips: '01123', name: 'Tallapoosa', state: 'AL', zipCodes: ['36003', '36006', '36067'] },
    '01125': { fips: '01125', name: 'Tuscaloosa', state: 'AL', zipCodes: ['35401', '35402', '35403', '35404', '35405', '35406', '35407', '35441', '35444', '35449', '35453', '35456', '35457', '35458', '35459', '35460', '35461', '35462', '35463', '35464', '35466', '35469', '35470', '35473', '35474', '35475', '35476', '35477', '35480', '35481', '35482', '35485', '35486', '35487', '35490', '35491', '35501', '35540', '35541', '35542', '35543', '35544', '35545', '35546', '35548', '35549', '35555', '35563', '35570', '35571', '35572', '35573', '35574', '35575', '35576', '35578', '35579', '35580', '35581', '35582', '35584', '35585', '35586', '35587', '35592', '35593', '35594'] },
    '01127': { fips: '01127', name: 'Walker', state: 'AL', zipCodes: ['35004', '35020', '35094', '35501', '35540', '35541', '35542', '35543', '35544', '35545', '35546', '35548', '35549', '35555', '35563', '35570', '35571', '35572', '35573', '35574', '35575', '35576', '35578', '35579', '35580', '35581', '35582', '35584', '35585', '35586', '35587', '35592', '35593', '35594'] },
    '01129': { fips: '01129', name: 'Washington', state: 'AL', zipCodes: ['36502', '36507', '36511'] },
    '01131': { fips: '01131', name: 'Wilcox', state: 'AL', zipCodes: ['36720', '36726', '36728'] },
    '01133': { fips: '01133', name: 'Winston', state: 'AL', zipCodes: ['35555', '35570', '35576'] }
  };

  // ============================================
  // SMARTYSTREETS API INTEGRATION
  // ============================================

  async zipToCountyFips(zipCode: string): Promise<{ fips: string; county: string } | null> {
    // Try SMARTYSTREETS API first
    if (this.authId && this.authToken) {
      try {
        const result = await this.callSmartyStreetsApi(zipCode);
        if (result) {
          return result;
        }
      } catch (error) {
        console.warn('SMARTYSTREETS API failed, falling back to manual mapping:', error);
      }
    }

    // Fallback to manual Alabama mapping
    return this.fallbackZipToFips(zipCode);
  }

  private async callSmartyStreetsApi(zipCode: string): Promise<{ fips: string; county: string } | null> {
    const url = `${this.baseUrl}?auth-id=${this.authId}&auth-token=${this.authToken}&zipcode=${zipCode}`;
    
    try {
      const response = await fetch(url);
      
      if (!response.ok) {
        throw new Error(`SMARTYSTREETS API error: ${response.status}`);
      }

      const data: SmartyStreetsResponse = await response.json();
      
      if (data.results && data.results.length > 0) {
        const result = data.results[0];
        const fips = result.components.county_fips || result.metadata.county_fips;
        const county = result.components.county_name || result.metadata.county_name;
        
        if (fips && county) {
          console.log(`SMARTYSTREETS: ${zipCode} → ${county} County (${fips})`);
          return { fips, county };
        }
      }
      
      return null;
    } catch (error) {
      console.error('SMARTYSTREETS API call failed:', error);
      throw error;
    }
  }

  private fallbackZipToFips(zipCode: string): { fips: string; county: string } | null {
    // Search through Alabama counties for this zip code
    for (const [fips, countyInfo] of Object.entries(this.alabamaCountyMapping)) {
      if (countyInfo.zipCodes.includes(zipCode)) {
        console.log(`Fallback mapping: ${zipCode} → ${countyInfo.name} County (${fips})`);
        return { fips, county: countyInfo.name };
      }
    }

    console.warn(`No mapping found for zip code: ${zipCode}`);
    return null;
  }

  // ============================================
  // UTILITY METHODS
  // ============================================

  getCountyInfo(fips: string): CountyInfo | null {
    return this.alabamaCountyMapping[fips] || null;
  }

  getAllAlabamaCounties(): CountyInfo[] {
    return Object.values(this.alabamaCountyMapping);
  }

  isAlabamaZipCode(zipCode: string): boolean {
    return Object.values(this.alabamaCountyMapping).some(county => 
      county.zipCodes.includes(zipCode)
    );
  }
}

// Export singleton instance
export const geoService = new GeoService();
